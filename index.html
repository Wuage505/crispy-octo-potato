<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
    <title>中药识别 - 枸杞与菊花</title>
    <!-- 外部资源 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.14.0/dist/tf.min.js"></script>
    
    <!-- Tailwind 自定义配置 -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#16a34a',
                        secondary: '#b45309',
                    }
                }
            }
        }
    </script>
    
    <style type="text/tailwindcss">
        @layer utilities {
            .transition-all-300 {
                transition: all 300ms ease-in-out;
            }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen pb-20">
    <header class="bg-white shadow-md fixed top-0 left-0 right-0 z-50">
        <div class="container mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center space-x-2">
                <i class="fa fa-leaf text-primary text-2xl"></i>
                <h1 class="text-xl font-bold">中药识别</h1>
            </div>
            <div id="status-indicator" class="text-sm text-gray-500 flex items-center">
                <i class="fa fa-circle-o-notch fa-spin mr-1"></i>
                <span>准备中...</span>
            </div>
        </div>
    </header>

    <main class="container mx-auto px-4 pt-20 pb-16">
        <!-- 提示信息 -->
        <div class="bg-blue-50 border-l-4 border-blue-400 p-4 mb-6 text-sm rounded-r">
            <div class="flex">
                <i class="fa fa-info-circle text-blue-400 mt-0.5 mr-2"></i>
                <div>
                    <p class="text-blue-700 mb-1"><strong>手机用户注意：</strong>请使用清晰的特写照片，避免复杂背景</p>
                    <p class="text-blue-600 text-xs">识别可能需要3-8秒，请耐心等待，不要重复点击</p>
                </div>
            </div>
        </div>
        
        <!-- 上传区域 -->
        <div id="upload-area" class="border-2 border-dashed border-gray-300 rounded-xl p-8 text-center mb-6 cursor-pointer transition-all-300 hover:border-primary hover:bg-green-50">
            <input type="file" id="image-upload" accept="image/*" class="hidden" />
            <div class="flex flex-col items-center">
                <i class="fa fa-cloud-upload text-5xl text-gray-400 mb-4"></i>
                <h3 class="text-lg font-medium text-gray-700 mb-2">上传药材图片</h3>
                <p class="text-sm text-gray-500 mb-4 max-w-xs">点击或拖拽图片到此处</p>
                <button id="browse-btn" class="bg-primary hover:bg-primary/90 text-white px-5 py-2 rounded-lg text-sm transition-all-300">
                    <i class="fa fa-image mr-1"></i> 选择图片
                </button>
            </div>
        </div>
        
        <!-- 预览区域 -->
        <div id="preview-container" class="hidden mb-6">
            <div class="bg-white rounded-xl shadow p-4">
                <h3 class="text-center text-gray-700 mb-3">图片预览</h3>
                <div class="flex justify-center p-4 bg-gray-50 rounded-lg mb-4">
                    <img id="preview-image" class="max-w-full max-h-64 object-contain rounded" src="assets/placeholder.jpg" alt="预览图片" />
                </div>
                <div class="flex justify-center">
                    <button id="analyze-btn" class="bg-secondary hover:bg-secondary/90 text-white px-6 py-2 rounded-lg text-sm transition-all-300 disabled:opacity-70 disabled:cursor-not-allowed" disabled>
                        <i class="fa fa-search mr-1"></i> 请等待模型加载
                    </button>
                </div>
            </div>
        </div>
        
        <!-- 结果区域 -->
        <div id="result-container" class="bg-white rounded-xl shadow p-6 mb-6 hidden">
            <h2 class="text-lg font-semibold mb-4 text-center">识别结果</h2>
            <div class="flex flex-col items-center">
                <div class="w-48 h-48 rounded-lg overflow-hidden mb-4 border-2 border-gray-200">
                    <img id="result-image" src="assets/placeholder.jpg" class="w-full h-full object-cover" alt="识别图片" />
                </div>
                <div id="prediction-result" class="text-center p-4 rounded-lg w-full max-w-xs bg-gray-50">
                </div>
            </div>
        </div>
        
        <!-- 药材信息区域 -->
        <div id="herb-info" class="bg-white rounded-xl shadow p-5 mb-6 hidden">
            <h2 id="herb-name" class="text-lg font-semibold mb-3 border-b pb-2"></h2>
            <div id="herb-description" class="text-gray-600 text-sm space-y-2">
            </div>
        </div>
        
        <!-- 超时提示 -->
        <div id="timeout-alert" class="hidden bg-yellow-50 border-l-4 border-yellow-400 p-4 mb-6 rounded-r">
            <div class="flex">
                <i class="fa fa-clock-o text-yellow-400 mt-0.5 mr-2"></i>
                <p class="text-yellow-700 text-sm">识别时间较长，正在加速处理...</p>
            </div>
        </div>
    </main>

    <footer class="bg-white border-t border-gray-200 fixed bottom-0 left-0 right-0 py-3">
        <div class="container mx-auto px-4 text-center text-sm text-gray-500">
            <p>中药识别系统 | 优化版</p>
        </div>
    </footer>

    <!-- 核心优化：使用Web Worker避免主线程阻塞 -->
    <script id="worker-script" type="javascript/worker">
        importScripts('https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.14.0/dist/tf.min.js');
        
        let model = null;
        const MODEL_PATH = 'model/model.json';

        // 初始化模型（只加载一次）
        async function initModel() {
            if (!model) {
                model = await tf.loadLayersModel(MODEL_PATH);
            }
            return model;
        }

        // 处理图像并预测
        async function processImage(imageData, inputSize) {
            const model = await initModel();
            
            // 转换为tensor并预处理
            const tensor = tf.tidy(() => {
                return tf.browser.fromPixels(imageData)
                    .resizeBilinear([inputSize, inputSize])
                    .toFloat()
                    .div(255.0)
                    .expandDims(0);
            });

            // 预测并返回结果
            const result = await model.predict(tensor).data();
            tf.dispose(tensor);
            return result;
        }

        // 接收主线程消息
        self.onmessage = async (e) => {
            if (e.data.type === 'predict') {
                try {
                    const scores = await processImage(e.data.imageData, e.data.inputSize);
                    self.postMessage({ type: 'result', scores });
                } catch (error) {
                    self.postMessage({ type: 'error', message: error.message });
                }
            }
        };
    </script>

    <script>
        // 提取Worker脚本内容创建Blob URL（解决跨域问题）
        const workerScript = document.getElementById('worker-script').textContent;
        const blob = new Blob([workerScript], { type: 'application/javascript' });
        const workerUrl = URL.createObjectURL(blob);
        const inferenceWorker = new Worker(workerUrl); // 创建Web Worker

        // DOM元素
        const statusIndicator = document.getElementById('status-indicator');
        const imageUpload = document.getElementById('image-upload');
        const previewContainer = document.getElementById('preview-container');
        const previewImage = document.getElementById('preview-image');
        const analyzeBtn = document.getElementById('analyze-btn');
        const resultContainer = document.getElementById('result-container');
        const resultImage = document.getElementById('result-image');
        const predictionResult = document.getElementById('prediction-result');
        const herbInfo = document.getElementById('herb-info');
        const herbName = document.getElementById('herb-name');
        const herbDescription = document.getElementById('herb-description');
        const uploadArea = document.getElementById('upload-area');
        const browseBtn = document.getElementById('browse-btn');
        const timeoutAlert = document.getElementById('timeout-alert');

        // 全局变量
        const labels = ['枸杞', '菊花'];
        let currentImage = null;
        const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
        const inputSize = isMobile ? 128 : 224; // 手机端用更小尺寸（128x128）

        // 中药信息
        const herbData = {
            '枸杞': {
                name: '枸杞 (Gǒu Qǐ)',
                description: `
                    <p><strong>性味：</strong>甘，平</p>
                    <p><strong>归经：</strong>肝、肾经</p>
                    <p><strong>功效：</strong>滋补肝肾，益精明目</p>
                `
            },
            '菊花': {
                name: '菊花 (Jú Huā)',
                description: `
                    <p><strong>性味：</strong>甘、苦，微寒</p>
                    <p><strong>归经：</strong>肺、肝经</p>
                    <p><strong>功效：</strong>散风清热，平肝明目</p>
                `
            }
        };

        // 初始化
        function initApp() {
            // 检查TensorFlow.js
            if (typeof tf === 'undefined') {
                showError('TensorFlow.js加载失败，请刷新页面');
                return;
            }

            // 监听Worker消息
            inferenceWorker.onmessage = (e) => {
                if (e.data.type === 'result') {
                    handlePredictionResult(e.data.scores);
                } else if (e.data.type === 'error') {
                    handlePredictionError(e.data.message);
                }
            };

            // 初始化事件
            initEventListeners();
            showStatus('准备就绪，请上传图片');
        }

        // 处理图片上传
        function handleImageUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            // 验证文件
            const fileExt = file.name.split('.').pop().toLowerCase();
            if (!['jpg', 'jpeg', 'png'].includes(fileExt)) {
                showError('仅支持JPG/PNG格式');
                return;
            }

            if (file.size > 3 * 1024 * 1024) { // 限制3MB以内
                showError('图片过大，请压缩至3MB以内');
                return;
            }

            // 预览图片
            const reader = new FileReader();
            reader.onload = (e) => {
                currentImage = e.target.result;
                previewImage.src = currentImage;
                previewContainer.classList.remove('hidden');
                resultContainer.classList.add('hidden');
                herbInfo.classList.add('hidden');
            };
            reader.readAsDataURL(file);
        }

        // 开始识别（核心优化：使用Worker异步处理）
        function startAnalysis() {
            if (!currentImage) return;

            showStatus('识别中...');
            analyzeBtn.disabled = true;
            analyzeBtn.innerHTML = '<i class="fa fa-spinner fa-spin mr-1"></i> 识别中';
            timeoutAlert.classList.add('hidden');

            // 超时提示（5秒后显示）
            const timeoutTimer = setTimeout(() => {
                timeoutAlert.classList.remove('hidden');
            }, 5000);

            // 加载图片并发送到Worker
            const img = new Image();
            img.src = currentImage;
            img.onload = () => {
                // 创建缩略图（降低分辨率）
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                canvas.width = inputSize;
                canvas.height = inputSize;

                // 绘制图片（保持比例）
                const ratio = Math.min(inputSize / img.width, inputSize / img.height);
                const w = img.width * ratio;
                const h = img.height * ratio;
                ctx.drawImage(img, (inputSize - w) / 2, (inputSize - h) / 2, w, h);

                // 发送图像数据到Worker
                const imageData = ctx.getImageData(0, 0, inputSize, inputSize);
                inferenceWorker.postMessage({
                    type: 'predict',
                    imageData: imageData,
                    inputSize: inputSize
                });

                // 清除超时提示计时器
                clearTimeout(timeoutTimer);
            };

            img.onerror = () => {
                showError('图片加载失败，请重新上传');
                analyzeBtn.disabled = false;
                analyzeBtn.innerHTML = '<i class="fa fa-search mr-1"></i> 开始识别';
            };
        }

        // 处理识别结果
        function handlePredictionResult(scores) {
            // 解析结果
            let maxScore = -1;
            let predictedClass = 0;
            scores.forEach((score, index) => {
                if (score > maxScore) {
                    maxScore = score;
                    predictedClass = index;
                }
            });

            const confidence = Math.round(maxScore * 100);
            const herb = labels[predictedClass];

            // 显示结果
            resultImage.src = currentImage;
            predictionResult.innerHTML = `
                <div class="text-xl font-bold ${confidence > 70 ? 'text-green-600' : 'text-orange-600'}">${herb}</div>
                <div class="text-sm text-gray-500">可信度: ${confidence}%</div>
            `;

            herbName.textContent = herb + ' 信息';
            herbDescription.innerHTML = herbData[herb].description;

            resultContainer.classList.remove('hidden');
            herbInfo.classList.remove('hidden');
            timeoutAlert.classList.add('hidden');
            showStatus('识别完成');
            analyzeBtn.disabled = false;
            analyzeBtn.innerHTML = '<i class="fa fa-search mr-1"></i> 重新识别';
        }

        // 处理识别错误
        function handlePredictionError(message) {
            showError('识别失败: ' + message);
            analyzeBtn.disabled = false;
            analyzeBtn.innerHTML = '<i class="fa fa-search mr-1"></i> 重试识别';
            timeoutAlert.classList.add('hidden');
        }

        // 工具函数
        function showStatus(text) {
            statusIndicator.innerHTML = `<i class="fa fa-info-circle text-blue-500 mr-1"></i><span>${text}</span>`;
        }

        function showError(text) {
            statusIndicator.innerHTML = `<i class="fa fa-exclamation-triangle text-red-500 mr-1"></i><span class="text-red-500">${text}</span>`;
        }

        // 事件监听
        function initEventListeners() {
            // 上传相关
            browseBtn.addEventListener('click', () => imageUpload.click());
            uploadArea.addEventListener('click', () => imageUpload.click());
            imageUpload.addEventListener('change', handleImageUpload);
            analyzeBtn.addEventListener('click', startAnalysis);

            // 手机触摸支持
            browseBtn.addEventListener('touchstart', (e) => {
                e.preventDefault();
                imageUpload.click();
            });
            uploadArea.addEventListener('touchstart', (e) => {
                e.preventDefault();
                imageUpload.click();
            });

            // 拖放功能
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('border-primary', 'bg-green-50');
            });
            uploadArea.addEventListener('dragleave', () => {
                uploadArea.classList.remove('border-primary', 'bg-green-50');
            });
            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('border-primary', 'bg-green-50');
                if (e.dataTransfer.files[0]) {
                    imageUpload.files = e.dataTransfer.files;
                    handleImageUpload({ target: imageUpload });
                }
            });
        }

        // 页面加载完成后初始化
        window.addEventListener('load', initApp);

        // 页面关闭时释放资源
        window.addEventListener('beforeunload', () => {
            inferenceWorker.terminate();
            URL.revokeObjectURL(workerUrl);
        });
    </script>
</body>
</html>
